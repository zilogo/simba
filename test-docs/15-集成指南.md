# 智云科技系统集成指南

## 概述

本指南介绍如何将智云科技智能客服系统集成到您的应用中。我们提供多种集成方式，满足不同场景的需求。

## 集成方式

### 1. Web Widget 嵌入

最简单的集成方式，只需添加几行代码即可在网站上嵌入客服窗口。

#### 1.1 基础嵌入

在网页的 `</body>` 标签前添加以下代码：

```html
<script>
  (function(w, d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s);
    js.id = id;
    js.src = 'https://widget.zhiyuntech.com/loader.js';
    js.setAttribute('data-app-id', 'YOUR_APP_ID');
    fjs.parentNode.insertBefore(js, fjs);
  })(window, document, 'script', 'zhiyun-widget');
</script>
```

将 `YOUR_APP_ID` 替换为您在管理后台获取的应用ID。

#### 1.2 高级配置

支持更多自定义配置：

```html
<script>
  window.zhiyunConfig = {
    appId: 'YOUR_APP_ID',
    position: 'right',           // 窗口位置：left/right
    primaryColor: '#1890ff',     // 主题颜色
    title: '在线客服',           // 窗口标题
    welcomeMessage: '您好！有什么可以帮您？',  // 欢迎语
    user: {
      id: 'user_123',            // 用户ID
      name: '张三',              // 用户姓名
      email: 'zhangsan@example.com',  // 邮箱
      phone: '13800138000'       // 手机号
    },
    metadata: {
      source: 'website',         // 来源
      page: 'product_detail'     // 当前页面
    }
  };
</script>
<script src="https://widget.zhiyuntech.com/loader.js"></script>
```

#### 1.3 JavaScript API

Widget 提供 JavaScript API 供编程控制：

```javascript
// 打开聊天窗口
window.ZhiyunWidget.open();

// 关闭聊天窗口
window.ZhiyunWidget.close();

// 发送消息
window.ZhiyunWidget.sendMessage('我想咨询产品价格');

// 更新用户信息
window.ZhiyunWidget.updateUser({
  id: 'user_456',
  name: '李四'
});

// 监听事件
window.ZhiyunWidget.on('message', function(msg) {
  console.log('收到消息:', msg);
});

window.ZhiyunWidget.on('open', function() {
  console.log('窗口已打开');
});

window.ZhiyunWidget.on('close', function() {
  console.log('窗口已关闭');
});
```

### 2. SDK 集成

我们提供多种语言的 SDK，方便深度集成。

#### 2.1 Python SDK

**安装**

```bash
pip install zhiyun-sdk
```

**使用示例**

```python
from zhiyun import ZhiyunClient

# 初始化客户端
client = ZhiyunClient(api_key='YOUR_API_KEY')

# 创建会话
conversation = client.conversations.create(
    user_id='user_123',
    channel='api'
)

# 发送消息并获取回复
response = client.messages.send(
    conversation_id=conversation.id,
    message='你好，我想咨询产品价格'
)

print(response.reply)  # 智能回复内容
print(response.confidence)  # 置信度
print(response.sources)  # 引用来源
```

#### 2.2 Node.js SDK

**安装**

```bash
npm install zhiyun-sdk
```

**使用示例**

```javascript
const { ZhiyunClient } = require('zhiyun-sdk');

// 初始化客户端
const client = new ZhiyunClient({
  apiKey: 'YOUR_API_KEY'
});

// 创建会话
const conversation = await client.conversations.create({
  userId: 'user_123',
  channel: 'api'
});

// 发送消息并获取回复
const response = await client.messages.send({
  conversationId: conversation.id,
  message: '你好，我想咨询产品价格'
});

console.log(response.reply);
```

#### 2.3 Java SDK

**Maven 依赖**

```xml
<dependency>
  <groupId>com.zhiyuntech</groupId>
  <artifactId>zhiyun-sdk</artifactId>
  <version>1.0.0</version>
</dependency>
```

**使用示例**

```java
import com.zhiyuntech.sdk.ZhiyunClient;
import com.zhiyuntech.sdk.model.*;

// 初始化客户端
ZhiyunClient client = new ZhiyunClient("YOUR_API_KEY");

// 创建会话
Conversation conversation = client.conversations()
    .create(new ConversationRequest()
        .userId("user_123")
        .channel("api"));

// 发送消息
MessageResponse response = client.messages()
    .send(new MessageRequest()
        .conversationId(conversation.getId())
        .message("你好，我想咨询产品价格"));

System.out.println(response.getReply());
```

### 3. Webhook 集成

通过 Webhook 接收实时事件通知。

#### 3.1 配置 Webhook

在管理后台"系统设置 > Webhook"中配置：

1. 填写回调URL
2. 选择订阅事件类型
3. 设置签名密钥
4. 保存配置

#### 3.2 事件类型

| 事件类型 | 说明 |
|----------|------|
| conversation.created | 会话创建 |
| conversation.closed | 会话结束 |
| message.received | 收到消息 |
| message.sent | 发送消息 |
| ticket.created | 工单创建 |
| ticket.updated | 工单更新 |

#### 3.3 Webhook 请求格式

```json
{
  "event": "message.received",
  "timestamp": "2024-01-15T10:30:00Z",
  "data": {
    "conversation_id": "conv_123",
    "message_id": "msg_456",
    "content": "你好",
    "user_id": "user_789"
  },
  "signature": "sha256=xxxxx"
}
```

#### 3.4 签名验证

```python
import hmac
import hashlib

def verify_signature(payload, signature, secret):
    expected = 'sha256=' + hmac.new(
        secret.encode(),
        payload.encode(),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(expected, signature)
```

### 4. 微信集成

#### 4.1 微信公众号

1. 在微信公众平台配置服务器URL
2. 在智云后台获取Token和AESKey
3. 配置消息接收和回复

#### 4.2 微信小程序

使用我们的小程序组件：

```json
{
  "usingComponents": {
    "zhiyun-chat": "zhiyun-miniprogram/chat/chat"
  }
}
```

```html
<zhiyun-chat app-id="YOUR_APP_ID" user-id="{{userId}}"></zhiyun-chat>
```

### 5. APP SDK

#### 5.1 iOS SDK

**CocoaPods 安装**

```ruby
pod 'ZhiyunSDK', '~> 1.0'
```

**使用示例**

```swift
import ZhiyunSDK

// 初始化
ZhiyunSDK.initialize(appId: "YOUR_APP_ID")

// 设置用户
ZhiyunSDK.setUser(userId: "user_123", name: "张三")

// 打开客服页面
let chatVC = ZhiyunChatViewController()
navigationController?.pushViewController(chatVC, animated: true)
```

#### 5.2 Android SDK

**Gradle 依赖**

```groovy
implementation 'com.zhiyuntech:sdk:1.0.0'
```

**使用示例**

```java
// 初始化
ZhiyunSDK.init(context, "YOUR_APP_ID");

// 设置用户
ZhiyunSDK.setUser("user_123", "张三");

// 打开客服页面
ZhiyunSDK.openChat(activity);
```

## 常见问题

### Q: Widget 加载很慢怎么办？
A: 建议将 Widget 脚本放在页面底部异步加载，不影响页面主要内容的加载。

### Q: 如何在移动端适配？
A: Widget 已经做了移动端适配，会自动识别设备类型并调整布局。

### Q: 支持离线消息吗？
A: 支持。用户离线时发送的消息会保存，用户下次上线时会收到。

## 技术支持

如需集成帮助，请联系：
- 邮箱：integrate@zhiyuntech.com
- 文档：docs.zhiyuntech.com
- 示例代码：github.com/zhiyuntech/examples
