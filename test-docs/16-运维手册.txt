智云科技系统运维手册

本手册面向系统运维人员，介绍智云科技智能客服系统的日常运维和故障处理方法。

========================================
第一部分：日常运维
========================================

一、系统监控

1. 健康检查

系统提供健康检查接口，用于监控服务状态：

接口地址：GET /api/health
返回示例：
{
  "status": "healthy",
  "components": {
    "database": "healthy",
    "redis": "healthy",
    "qdrant": "healthy",
    "llm": "healthy"
  },
  "timestamp": "2024-01-15T10:30:00Z"
}

建议配置监控系统定期调用此接口，异常时触发告警。

2. 性能指标

系统暴露Prometheus格式的指标：

接口地址：GET /api/metrics
主要指标：
- http_requests_total：HTTP请求总数
- http_request_duration_seconds：请求耗时
- active_conversations：活跃会话数
- message_processing_time：消息处理时间
- llm_request_duration：LLM调用耗时
- embedding_request_duration：Embedding调用耗时

3. 日志管理

日志文件位置：
- 应用日志：/var/log/zhiyun/app.log
- 访问日志：/var/log/zhiyun/access.log
- 错误日志：/var/log/zhiyun/error.log

日志级别：DEBUG < INFO < WARNING < ERROR < CRITICAL
生产环境建议设置为INFO级别。

日志轮转配置（logrotate）：
/var/log/zhiyun/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
}

二、备份恢复

1. 数据库备份

自动备份脚本（每日执行）：
#!/bin/bash
DATE=$(date +%Y%m%d)
BACKUP_DIR=/backup/database
mkdir -p $BACKUP_DIR
pg_dump -h localhost -U postgres zhiyun | gzip > $BACKUP_DIR/zhiyun_$DATE.sql.gz
# 保留30天备份
find $BACKUP_DIR -name "*.sql.gz" -mtime +30 -delete

手动备份命令：
docker-compose exec db pg_dump -U postgres zhiyun > backup.sql

2. 数据恢复

从备份恢复：
gunzip -c backup_20240115.sql.gz | docker-compose exec -T db psql -U postgres zhiyun

注意：恢复前请先停止应用服务，恢复后重启服务。

3. 知识库备份

知识库数据存储在Qdrant向量数据库中。

备份命令：
curl -X POST http://localhost:6333/collections/knowledge/snapshots

恢复命令：
curl -X PUT http://localhost:6333/collections/knowledge/snapshots/recover \
  -H "Content-Type: application/json" \
  -d '{"location": "/snapshots/knowledge-xxx.snapshot"}'

三、容量管理

1. 磁盘空间

监控以下目录的磁盘使用：
- /var/lib/postgresql：数据库数据
- /var/lib/qdrant：向量数据库
- /var/lib/minio：文件存储
- /var/log：日志文件

建议阈值：
- 告警：使用率 > 70%
- 严重：使用率 > 85%
- 危急：使用率 > 95%

2. 连接池

数据库连接池配置：
- 最小连接数：10
- 最大连接数：100
- 连接超时：30秒
- 空闲超时：300秒

Redis连接池配置：
- 最大连接数：50
- 最大空闲连接：10
- 连接超时：5秒

3. 内存管理

各服务内存限制建议：
- Web服务：2GB
- Worker服务：4GB
- Redis：2GB
- PostgreSQL：4GB

监控内存使用，超过80%时考虑扩容或优化。

========================================
第二部分：故障处理
========================================

一、常见故障及处理

1. 服务无法启动

症状：服务启动失败或启动后立即退出

排查步骤：
a) 检查日志：docker-compose logs web
b) 检查配置：确认.env配置正确
c) 检查依赖：确认数据库、Redis等依赖服务正常
d) 检查端口：确认端口未被占用

常见原因及解决：
- 配置错误：检查并修正配置文件
- 端口占用：停止占用端口的进程或更换端口
- 依赖服务异常：先启动依赖服务
- 内存不足：增加服务器内存或优化配置

2. 响应缓慢

症状：系统响应时间明显变长

排查步骤：
a) 检查系统资源：top, htop, iostat
b) 检查数据库：慢查询日志、连接数
c) 检查网络：ping, traceroute
d) 检查外部服务：LLM API、Embedding API

常见原因及解决：
- CPU过载：扩容或优化代码
- 内存不足：增加内存或优化缓存
- 数据库慢查询：添加索引或优化SQL
- 网络延迟：检查网络配置
- 外部API慢：设置超时、添加重试机制

3. 数据库连接失败

症状：应用报数据库连接错误

排查步骤：
a) 检查数据库状态：docker-compose ps db
b) 检查连接配置：DATABASE_URL
c) 检查网络连通：telnet localhost 5432
d) 检查连接数：SELECT count(*) FROM pg_stat_activity

解决方法：
- 重启数据库服务
- 检查并修正连接配置
- 增加最大连接数
- 优化连接池配置

4. LLM调用失败

症状：智能回复功能异常

排查步骤：
a) 检查API Key配置
b) 检查网络连通性
c) 检查API服务状态
d) 查看错误日志

解决方法：
- 确认API Key有效
- 检查网络和防火墙
- 联系API提供商确认服务状态
- 启用降级策略

二、应急预案

1. 服务降级

当系统负载过高时，可以启用降级：
- 关闭非核心功能
- 限制并发请求数
- 返回缓存结果
- 使用简化的回复逻辑

2. 紧急回滚

如果新版本出现问题，执行回滚：
docker-compose pull --policy=always zhiyun:previous
docker-compose up -d

3. 灾难恢复

完整恢复流程：
a) 准备新环境
b) 恢复数据库
c) 恢复文件存储
d) 恢复向量数据库
e) 更新DNS指向
f) 验证服务正常

========================================
第三部分：性能优化
========================================

一、数据库优化

1. 索引优化
定期分析查询，添加必要索引：
ANALYZE;
CREATE INDEX CONCURRENTLY idx_xxx ON table_xxx(column_xxx);

2. 查询优化
使用EXPLAIN ANALYZE分析慢查询：
EXPLAIN ANALYZE SELECT * FROM conversations WHERE ...;

3. 定期维护
VACUUM ANALYZE;  -- 清理和分析
REINDEX;  -- 重建索引

二、缓存优化

1. 合理设置缓存过期时间
2. 使用缓存预热
3. 监控缓存命中率

三、应用优化

1. 使用连接池
2. 异步处理非关键任务
3. 批量操作减少IO次数

如遇无法解决的问题，请联系技术支持：
电话：400-888-9999 转 8
邮箱：ops@zhiyuntech.com
